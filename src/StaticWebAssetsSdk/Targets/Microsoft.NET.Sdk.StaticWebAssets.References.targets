<!--
***********************************************************************************************
Microsoft.NET.Sdk.StaticWebAssets.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (c) .NET Foundation. All rights reserved.
***********************************************************************************************
-->

<Project ToolsVersion="14.0">

  <Target Name="_CleanupReferencedProjectItemGroups" BeforeTargets="GetCopyToPublishDirectoryItems" DependsOnTargets="ResolveStaticWebAssetsConfiguration">
    <ReadStaticWebAssetsManifestFile ManifestPath="$(StaticWebAssetBuildManifestPath)" Condition="'$(GeneratedWebAssetManifests)' != 'true'">
      <Output TaskParameter="Assets" ItemName="_CleanupStaticWebAsset" />
    </ReadStaticWebAssetsManifestFile>

    <ItemGroup>
      <_CleanupStaticWebAsset Include="@(StaticWebAsset)" Condition="'$(GeneratedWebAssetManifests)' == 'true'" />
      <Content Remove="@(_CleanupStaticWebAsset->'%(OriginalItemSpec)')" />
      <ContentWithTargetPath Remove="@(_CleanupStaticWebAsset->'%(OriginalItemSpec)')" />
      <None Remove="@(_CleanupStaticWebAsset->'%(OriginalItemSpec)')" />
      <_NoneWithTargetPath Remove="@(_CleanupStaticWebAsset->'%(OriginalItemSpec)')" />
      <ResolvedFileToPublish Remove="@(_CleanupStaticWebAsset->'%(OriginalItemSpec)')" />
    </ItemGroup>
  </Target>

  <Target Name="ResolveReferencedProjectsStaticWebAssetsConfiguration" DependsOnTargets="ResolveStaticWebAssetsConfiguration;PrepareProjectReferences">
    <ItemGroup>
      <!-- It is explicitly ok to take a dependency on _MSBuildProjectReferenceExistent as it is
        something many other products already take a dependency on. -->
      <_StaticWebAssetProjectReference Include="@(_MSBuildProjectReferenceExistent)" Condition="'%(BuildReference)' == 'true' and '@(ProjectReferenceWithConfiguration)' != ''" />
    </ItemGroup>

    <MSBuild
      Condition="'@(_StaticWebAssetProjectReference)' != ''"
      Targets="GetStaticWebAssetsProjectConfiguration"
      Properties="%(_StaticWebAssetProjectReference.SetConfiguration);%(_StaticWebAssetProjectReference.SetPlatform);%(_StaticWebAssetProjectReference.SetTargetFramework)"
      RemoveProperties="%(_StaticWebAssetProjectReference.GlobalPropertiesToRemove);$(_GlobalPropertiesToRemoveFromProjectReferences)"
      Projects="@(_StaticWebAssetProjectReference)"
      BuildInParallel="$(BuildInParallel)"
      ContinueOnError="!$(BuildingProject)"
      SkipNonexistentTargets="true">

      <Output TaskParameter="TargetOutputs" ItemName="_ReferencedProjectsConfiguration" />
    </MSBuild>

    <ItemGroup Condition="'$(BuildingInsideVisualStudio)' == 'true'">
      <_ReferenceManifestPath Include="@(_ReferencedProjectsConfiguration->'%(BuildManifestPath)')" Condition="'%(_ReferencedProjectsConfiguration.BuildManifestPath)' != ''" />
    </ItemGroup>

    <WriteLinesToFile Condition="'$(BuildingInsideVisualStudio)' == 'true'"
      File="$(StaticWebAssetReferencesUpToDateCheckManifestPath)"
      Lines="@(_ReferenceManifestPath)"
      Overwrite="false"
      WriteOnlyWhenDifferent="true" />

    <MergeConfigurationProperties
      CandidateConfigurations="@(_ReferencedProjectsConfiguration)"
      ProjectReferences="@(_StaticWebAssetProjectReference)">

      <Output TaskParameter="ProjectConfigurations" ItemName="StaticWebAssetProjectConfiguration" />
    </MergeConfigurationProperties>

  </Target>

  <!--
    The static web asset configuration defines the following metadata:
    Version: Version of the contract supported by this project, it can be 1 or 2.
    Source: The package id of the project.
    GetBuildAssetsTargets: The targets to run to get the build assets.
    GetPublishAssetsTargets: The targets to run to get the publish assets.
    AdditionalBuildProperties: Additional properties to pass to the build assets targets.
    AdditionalBuildPropertiesToRemove: Additional properties to remove from the build assets targets.
    AdditionalPublishProperties: Additional properties to pass to the publish assets targets.
    AdditionalPublishPropertiesToRemove: Additional properties to remove from the publish assets targets.
    TargetFramework: The target framework associated with the current configuration.
  -->
  <Target Name="GetStaticWebAssetsProjectConfiguration" Returns="@(_StaticWebAssetThisProjectConfiguration)" DependsOnTargets="ResolveStaticWebAssetsConfiguration">
      <PropertyGroup>
        <StaticWebAssetsGetPublishAssetsTargets Condition="'$(StaticWebAssetsGetPublishAssetsTargets)' == ''">ComputeReferencedStaticWebAssetsPublishManifest;GetCurrentProjectPublishStaticWebAssetItems</StaticWebAssetsGetPublishAssetsTargets>
        <StaticWebAssetsGetBuildAssetsTargets Condition="'$(StaticWebAssetsGetBuildAssetsTargets)' == ''">GetCurrentProjectBuildStaticWebAssetItems</StaticWebAssetsGetBuildAssetsTargets>
      </PropertyGroup>
      <ItemGroup>
        <_StaticWebAssetThisProjectConfiguration Include="$(MSBuildProjectFullPath)">
          <Version>2</Version>
          <Source>$(PackageId)</Source>
          <TargetFramework>$(TargetFramework)</TargetFramework>
          <!-- Build -->
          <GetBuildAssetsTargets>$(StaticWebAssetsGetBuildAssetsTargets)</GetBuildAssetsTargets>
          <AdditionalBuildProperties>$(StaticWebAssetsAdditionalBuildProperties)</AdditionalBuildProperties>
          <AdditionalBuildPropertiesToRemove>$(StaticWebAssetsAdditionalBuildPropertiesToRemove)</AdditionalBuildPropertiesToRemove>
          <!-- Publish -->
          <GetPublishAssetsTargets>$(StaticWebAssetsGetPublishAssetsTargets)</GetPublishAssetsTargets>
          <AdditionalPublishProperties>$(StaticWebAssetsAdditionalPublishProperties)</AdditionalPublishProperties>
          <AdditionalPublishPropertiesToRemove>$(StaticWebAssetsAdditionalPublishPropertiesToRemove)</AdditionalPublishPropertiesToRemove>
          <!-- Build manifest -->
          <BuildManifestPath>$([System.IO.Path]::GetFullPath('$(StaticWebAssetBuildManifestPath)'))</BuildManifestPath>
        </_StaticWebAssetThisProjectConfiguration>
      </ItemGroup>
  </Target>

  <Target Name="ResolveReferencedProjectsStaticWebAssets" DependsOnTargets="ResolveReferencedProjectsStaticWebAssetsConfiguration"
    Deferred="Item:_ResolvedReferencedProjectBuildStaticWebAssetEndpoints:r;Item:_StaticWebAssetEndpointCanonicalMetadata:r;Item:_StaticWebAssetCanonicalMetadata:r">

      <MSBuild
        Condition="'@(StaticWebAssetProjectConfiguration)' != ''"
        Targets="%(StaticWebAssetProjectConfiguration.GetBuildAssetsTargets)"
        Properties="%(StaticWebAssetProjectConfiguration.AdditionalBuildProperties)"
        RemoveProperties="%(StaticWebAssetProjectConfiguration.AdditionalBuildPropertiesToRemove);$(_GlobalPropertiesToRemoveFromProjectReferences)"
        Projects="@(StaticWebAssetProjectConfiguration)"
        BuildInParallel="$(BuildInParallel)"
        ContinueOnError="!$(BuildingProject)"
        SkipNonexistentTargets="false"
      >
        <Output TaskParameter="TargetOutputs" ItemName="_ReferencedProjectBuildStaticWebAssetsItems" />
      </MSBuild>

      <MSBuild
        Condition="'@(StaticWebAssetProjectConfiguration)' != ''"
        Targets="%(StaticWebAssetProjectConfiguration.GetBuildAssetsTargets)Deferred"
        Properties="%(StaticWebAssetProjectConfiguration.AdditionalBuildProperties)"
        RemoveProperties="%(StaticWebAssetProjectConfiguration.AdditionalBuildPropertiesToRemove);$(_GlobalPropertiesToRemoveFromProjectReferences)"
        Projects="@(StaticWebAssetProjectConfiguration)"
        BuildInParallel="$(BuildInParallel)"
        ContinueOnError="!$(BuildingProject)"
        SkipNonexistentTargets="false"
      >
        <Output TaskParameter="TargetOutputs" ItemName="_ReferencedProjectBuildStaticWebAssetsItemsDeferred" />
      </MSBuild>

      <ItemGroup Condition="'@(StaticWebAssetProjectConfiguration)' != ''">
        <_ResolvedReferencedProjectBuildStaticWebAssetCandidatesNoFingerprints
          Include="@(_ReferencedProjectBuildStaticWebAssetsItems)"
          Condition="'%(_ReferencedProjectBuildStaticWebAssetsItems.ResultType)' == 'StaticWebAsset'"
          KeepMetadata="@(_StaticWebAssetCanonicalMetadata)" />

        <_ResolvedReferencedProjectBuildStaticWebAssetCandidatesResolved Deferred="true"
          Include="@(_ReferencedProjectBuildStaticWebAssetsItemsDeferred)"
          Condition="'%(_ReferencedProjectBuildStaticWebAssetsItemsDeferred.ResultType)' == 'StaticWebAssetResolved'"
          KeepMetadata="@(_StaticWebAssetCanonicalMetadata)" />

        <_ReferencedProjectBuildStaticWebAssetEndpointsUpdateCandidates Deferred="true"
          Include="@(_ReferencedProjectBuildStaticWebAssetsItemsDeferred)"
          Condition="'%(_ReferencedProjectBuildStaticWebAssetsItemsDeferred.ResultType)' == 'StaticWebAssetEndpoint'"
          KeepMetadata="@(_StaticWebAssetEndpointCanonicalMetadata)" />
      </ItemGroup>

      <ResolveStaticWebAssetFingerprintsUsingResolved
        Condition="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidatesNoFingerprints) != ''"
        Assets="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidatesNoFingerprints)"
        ResolvedAssets="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidatesResolved)">
        <Output TaskParameter="Assets" ItemName="_ResolvedReferencedProjectBuildStaticWebAssetCandidates" />
      </ResolveStaticWebAssetFingerprintsUsingResolved>

      <UpdateExternallyDefinedStaticWebAssets Condition="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidatesNoFingerprints) != ''"
        Assets="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidates)"
        Endpoints="@(_ReferencedProjectBuildStaticWebAssetEndpointsUpdateCandidates)"
        FingerprintInferenceExpressions="@(StaticWebAssetFingerprintInferenceExpression)"
      >
        <Output TaskParameter="UpdatedAssets" ItemName="_ResolvedReferencedProjectBuildStaticWebAssets" />
        <Output TaskParameter="UpdatedEndpoints" ItemName="_ResolvedReferencedProjectBuildStaticWebAssetEndpoints" />
        <Output TaskParameter="AssetsWithoutEndpoints" ItemName="_ReferencedProjectBuildStaticWebAssetsWithoutEndpoints" />
      </UpdateExternallyDefinedStaticWebAssets>

      <DefineStaticWebAssetEndpoints 
        Condition="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidatesNoFingerprints) != ''"
        DeferredCondition="'@(_ReferencedProjectBuildStaticWebAssetsWithoutEndpoints)' != ''"
        PrecomputeInputs="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidatesNoFingerprints)"
        CandidateAssets="@(_ReferencedProjectBuildStaticWebAssetsWithoutEndpoints)"
        ExistingEndpoints=""
        ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
      >
        <Output TaskParameter="Endpoints" ItemName="_ResolvedReferencedProjectBuildStaticWebAssetEndpoints" />
      </DefineStaticWebAssetEndpoints>

      <ItemGroup Condition="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidatesNoFingerprints->Count()) != 0">

        <StaticWebAsset Include="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidatesNoFingerprints)" />
        <StaticWebAssetFingerprints Deferred="true" Include="@(_ResolvedReferencedProjectBuildStaticWebAssetCandidatesResolved)" />
        <StaticWebAssetEndpoint Deferred="true" Include="@(_ResolvedReferencedProjectBuildStaticWebAssetEndpoints)" />

        <StaticWebAssetDiscoveryPattern
          Include="@(_ReferencedProjectBuildStaticWebAssetsItems)"
          Condition="'%(_ReferencedProjectBuildStaticWebAssetsItems.ResultType)' == 'StaticWebAssetDiscoveryPattern'"
          KeepMetadata="@(_StaticWebAssetDiscoveryPatternCanonicalMetadata)" />

      </ItemGroup>

  </Target>


  <Target Name="LoadCurrentProjectBuildStaticWebAssetItemsFromDisk" Condition="'$(GeneratedWebAssetManifests)' != 'true'">
    <Error Condition="'$(IsPrecomputeMode)' == 'true'" Text="The target 'LoadCurrentProjectBuildStaticWebAssetItemsFromDisk' cannot be used in precompute mode." />
    <ReadStaticWebAssetsManifestFile ManifestPath="$(StaticWebAssetBuildManifestPath)">
      <Output TaskParameter="Assets" ItemName="_CachedBuildStaticWebAssets" />
      <Output TaskParameter="Endpoints" ItemName="_CachedBuildStaticWebAssetEndpoints" />
      <Output TaskParameter="DiscoveryPatterns" ItemName="_CachedBuildStaticWebAssetDiscoveryPatterns" />
    </ReadStaticWebAssetsManifestFile>
    <ItemGroup>
      <_CachedBuildStaticWebAssetsResolved Include="@(_CachedBuildStaticWebAssets)" />
    </ItemGroup>
  </Target>

  <Target Name="LoadCurrentProjectBuildStaticWebAssetItemsFromMemory" Condition="'$(GeneratedWebAssetManifests)' == 'true'"
    Deferred="Item:StaticWebAssetResolved:r;Item:StaticWebAssetEndpoint:r">
    <ItemGroup>
      <_CachedBuildStaticWebAssets Include="@(StaticWebAsset)" />
      <_CachedBuildStaticWebAssetsResolved Deferred="true" Include="@(StaticWebAssetResolved)" />
      <_CachedBuildStaticWebAssetEndpoints Deferred="true" Include="@(StaticWebAssetEndpoint)" />
      <_CachedBuildStaticWebAssetDiscoveryPatterns Include="@(StaticWebAssetDiscoveryPattern)" />
    </ItemGroup>
  </Target>
  
  <Target Name="LoadCurrentProjectBuildStaticWebAssetItems" DependsOnTargets="ResolveStaticWebAssetsConfiguration;LoadCurrentProjectBuildStaticWebAssetItemsFromDisk;LoadCurrentProjectBuildStaticWebAssetItemsFromMemory" />

  <Target Name="LoadCurrentProjectBuildStaticWebAssetItemsForReference" DependsOnTargets="ResolveStaticWebAssetsConfiguration;LoadCurrentProjectBuildStaticWebAssetItems">
      <ComputeReferenceStaticWebAssetItems
        Assets="@(_CachedBuildStaticWebAssets)"
        Patterns="@(_CachedBuildStaticWebAssetDiscoveryPatterns)"
        ProjectMode="$(StaticWebAssetProjectMode)"
        AssetKind="Build"
        Source="$(PackageId)"
      >
        <Output TaskParameter="StaticWebAssets" ItemName="_CachedBuildReferencedStaticWebAsset" />
        <Output TaskParameter="DiscoveryPatterns" ItemName="_CachedBuildReferencedStaticWebAssetDiscoveryPatterns" />
      </ComputeReferenceStaticWebAssetItems>

      <ComputeEndpointsForReferenceStaticWebAssets
        Assets="@(_CachedBuildStaticWebAssetsResolved)"
        CandidateEndpoints="@(_CachedBuildStaticWebAssetEndpoints)"
      >
        <Output TaskParameter="Endpoints" ItemName="_CachedBuildReferencedStaticWebAssetEndpoints" />
      </ComputeEndpointsForReferenceStaticWebAssets>
  </Target>

  <Target Name="GetCurrentProjectBuildStaticWebAssetItems" DependsOnTargets="LoadCurrentProjectBuildStaticWebAssetItemsForReference" Returns="@(_CachedBuildStaticWebAssetItems)">
      <ItemGroup>
        <_CachedBuildStaticWebassetItems Include="@(_CachedBuildReferencedStaticWebAsset)">
          <ResultType>StaticWebAsset</ResultType>
        </_CachedBuildStaticWebassetItems>
        <_CachedBuildStaticWebassetItems Include="@(_CachedBuildReferencedStaticWebAssetDiscoveryPatterns)">
          <ResultType>StaticWebAssetDiscoveryPattern</ResultType>
        </_CachedBuildStaticWebassetItems>
      </ItemGroup>
  </Target>

  <Target Name="GetCurrentProjectBuildStaticWebAssetItemsDeferred" DependsOnTargets="LoadCurrentProjectBuildStaticWebAssetItemsForReference" Returns="@(_CachedBuildStaticWebAssetItemsDeferred)" DeferredReturns="Item:_CachedBuildStaticWebAssetItemsDeferred"
    Deferred="Item:_CachedBuildStaticWebAssetsResolved:r;Item:_CachedBuildReferencedStaticWebAssetEndpoints:r">
      <ItemGroup>
        <_CachedBuildStaticWebAssetItemsDeferred Deferred="true" Include="@(_CachedBuildStaticWebAssetsResolved)">
          <ResultType>StaticWebAssetResolved</ResultType>
        </_CachedBuildStaticWebAssetItemsDeferred>
        <_CachedBuildStaticWebAssetItemsDeferred Deferred="true" Include="@(_CachedBuildReferencedStaticWebAssetEndpoints)">
          <ResultType>StaticWebAssetEndpoint</ResultType>
        </_CachedBuildStaticWebAssetItemsDeferred>
      </ItemGroup>
  </Target>

</Project>
